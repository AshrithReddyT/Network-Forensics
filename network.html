<!DOCTYPE html>
<meta charset="utf-8">

<style>
    body {
    background-color: black;
    }
    .link {
        stroke: #ccc;
    }

    .text {
        pointer-events: none;
        color: white;
        font: 10px sans-serif;
    }
    .svg-div{
     margin-top: 20%
     display: block;
     /* margin: 0 auto; */
     }
</style>

<body>
    <div class="svg-div">
        <center>
  
        </center>
      </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
    $.ajaxSetup({beforeSend: function(xhr){
    if (xhr.overrideMimeType)
    {
        xhr.overrideMimeType("application/json");
    }
    }
    });
    var previous = null;
    var current = null;
    setInterval(function() {
        $.getJSON("graph.json", function(json) {
            current = JSON.stringify(json);            
            if (previous && current && previous !== current) {
                location.reload();
            }
            previous = current;
        });                       
    }, 5000);   
</script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        var width = 1400,
            height = 725

        var svg = d3.select("center").append("svg")
            .attr("width", width)
            .attr("height", height); 

        var force = d3.forceSimulation() 
            .force("charge", d3.forceManyBody().strength(-500).distanceMin(50).distanceMax(200)) 
            .force("link", d3.forceLink().id(function(d) { return d.index }).distance(250).strength(0.5)) 
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("y", d3.forceY(0.001))
            .force("x", d3.forceX(0.001))

        var color = function (group) {
            if (group == 1) {
                return "#aaa"
            } else if (group == 2) {
                return "#fbc280"
            } else {
                return "#405275"
            }
        }
        function dragstarted(d) {
            if (!d3.event.active) force.alphaTarget(0.6).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }
        
        function dragended(d) {
            if (!d3.event.active) force.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        } 
        
        d3.json("graph.json", function (error, json) {
            if (error) throw error; 
            force
                .nodes(json.nodes) 
                .force("link").links(json.links)
                

            var link = svg.selectAll(".link")
                .data(json.links)
                .enter()
                .append("line")
                .attr("class", "link")
                .style("stroke", function(d) { if(d.value==0){return "red"} else{return "green"} });

            var node = svg.selectAll(".node")
                .data(json.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));  
            
                var tip;
                node.on("mouseover", function(d){
                    d3.event.stopPropagation(); 
                
                    if (tip) tip.remove();
                    
                    tip  = svg.append("g")
                    .attr("transform", "translate(" + d.x  + "," + d.y + ")");
                    
                    var rect = tip.append("rect")
                    .style("width", "400px")
                    .style("height", "120px")
                    .style("fill", "green")
                    .style("stroke", "steelblue");
                    
                    tip.append("text")
                    .text("Name: " + d.name)
                    .attr("dy", "1em")
                    .attr("x", 5)
                    .style("fill", "white");
                    
                    tip.append("text")
                    .text("Info: " + d.group)
                    .attr("dy", "2em")
                    .attr("x", 5)
                    .style("fill", "white");

                    var con = graph.links
                    .filter(function(d1){
                        return d1.source.id === d.id;
                    })
                    .map(function(d1){
                        return d1.target.name + " with weight " + d1.weight;
                    })
                    
                    tip.append("text")
                    .text("Connected to: " + con.join(","))
                    .attr("dy", "3em")
                    .attr("x", 5);
                    
                    var bbox = tip.node().getBBox();
                    rect.attr("width", bbox.width + 5)
                        .attr("height", bbox.height + 5)
                });
                node.on("mouseout", function(d){
                    d3.event.stopPropagation(); 
                
                    if (tip) tip.remove();
                });
            node.append('circle')
                .attr('r', 10)
                .attr('fill', function (d) {
                    return color(d.group);
                })
                .style("fill", function(d) { if(d.group==0){return "red"} else{return "light-blue"} });

            node.append("text")
                .attr("dx", -18)
                .attr("dy", 8)
                .style("font-family", "overwatch")
                .style("font-size", "15px")
                .style("fill", "white")

                .text(function (d) {
                    return d.name
                });

            force.on("tick", function () {
                link.attr("x1", function (d) {
                        return d.source.x;
                    })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });
                node.attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });
            });
        });
    </script>
